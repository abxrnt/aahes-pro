<!-- ========== CUTOFFS COMPONENT (NO HEAD/BODY) ========= -->

<section id="cutoffsPage" class="py-10 fade-in">
  <div class="max-w-5xl mx-auto">

    <!-- Title -->
    <h2 class="text-4xl font-bold text-emerald-800 text-center mb-2">
      CEE Cutoff Ranks & Marks
    </h2>

    <p class="text-gray-600 text-center mb-10">
      Official historical cutoffs collected from verified sources.  
      Select college, branch & category to view accurate results.
    </p>

    <!-- Filter Box -->
    <form id="cutoffFilter"
      class="grid gap-6 md:grid-cols-4 bg-white/80 backdrop-blur-md p-6 border border-emerald-200 shadow-lg rounded-2xl">

      <!-- College -->
      <div>
        <label class="font-semibold text-gray-800 mb-1 block">College</label>
        <select id="collegeSel"
          class="p-3 w-full rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-400">
          <option value="">Loading...</option>
        </select>
      </div>

      <!-- Branch -->
      <div>
        <label class="font-semibold text-gray-800 mb-1 block">Branch</label>
        <select id="branchSel"
          class="p-3 w-full rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-400">
          <option value="">Select College First</option>
        </select>
      </div>

      <!-- Category -->
      <div>
        <label class="font-semibold text-gray-800 mb-1 block">Category</label>
        <select id="catSel"
          class="p-3 w-full rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-400">
          <option value="">Select Category</option>
          <option value="GEN">GEN</option>
          <option value="OBC">OBC</option>
          <option value="SC">SC</option>
          <option value="STP">STP</option>
          <option value="STH">STH</option>
        </select>
      </div>

      <!-- Submit -->
      <div class="flex items-end">
        <button
          class="bg-emerald-600 text-white font-semibold px-6 py-3 w-full rounded-lg hover:bg-emerald-700 hover:scale-[1.02] transition">
          Submit
        </button>
      </div>

    </form>

    <!-- Results -->
    <div id="cutoffResults" class="grid md:grid-cols-3 gap-6 mt-12"></div>

  </div>
</section>


<!-- ========== FIRESTORE + LOGIC ========== -->
<script type="module">

  /* ---------------- FIREBASE INIT ---------------- */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    getDocs,
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBOVl1hdmprJXpgdN_sNTO3FsNePD_zNZY",
    authDomain: "aahes-cee-cutoffs.firebaseapp.com",
    projectId: "aahes-cee-cutoffs",
    storageBucket: "aahes-cee-cutoffs.firebasestorage.app",
    messagingSenderId: "706066626405",
    appId: "1:706066626405:web:0d254ab82beb288108938c",
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  /* -------------- STATE -------------- */
  let cutoffData = [];

  const collegeSel = document.getElementById("collegeSel");
  const branchSel = document.getElementById("branchSel");
  const catSel = document.getElementById("catSel");
  const cutoffResults = document.getElementById("cutoffResults");
  const cutoffFilter = document.getElementById("cutoffFilter");

  /* -------------- LOAD FIRESTORE DATA -------------- */
  async function loadCutoffs() {
    const snap = await getDocs(collection(db, "cutoffs"));
    cutoffData = snap.docs.map(d => d.data());

    // populate college dropdown
    const colleges = [...new Set(cutoffData.map(item => item.college))].sort();

    collegeSel.innerHTML = `<option value="">Select College</option>`;
    colleges.forEach(c => {
      collegeSel.innerHTML += `<option value="${c}">${c}</option>`;
    });
  }

  await loadCutoffs();

  /* -------------- LOAD BRANCHES WHEN COLLEGE CHANGES -------------- */
  collegeSel.addEventListener("change", () => {
    const selected = collegeSel.value;
    branchSel.innerHTML = `<option value="">Select Branch</option>`;
    if (!selected) return;

    const branches = [
      ...new Set(
        cutoffData.filter(item => item.college === selected).map(item => item.branch)
      )
    ].sort();

    branches.forEach(b => {
      branchSel.innerHTML += `<option value="${b}">${b}</option>`;
    });
  });

  /* -------------- SUBMIT FILTER -------------- */
  cutoffFilter.addEventListener("submit", e => {
    e.preventDefault();

    const college = collegeSel.value;
    const branch = branchSel.value;
    const cat = catSel.value;

    if (!college || !branch || !cat) {
      cutoffResults.innerHTML = `
        <p class="text-red-500 col-span-3 text-center font-semibold">
          ⚠️ Please fill all fields.
        </p>`;
      return;
    }

    const matches = cutoffData.filter(
      d => d.college === college && d.branch === branch && d.cat === cat
    );

    if (!matches.length) {
      cutoffResults.innerHTML = `
        <p class="text-gray-500 col-span-3 text-center">
          No data found for <b>${college}</b> — <b>${branch}</b> (${cat})
        </p>`;
      return;
    }

    // sort by round
    matches.sort((a, b) => Number(a.round) - Number(b.round));

    cutoffResults.innerHTML = matches
      .map(item => {
        return `
        <div class="glass p-6 border border-emerald-100 rounded-2xl shadow">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-sm text-gray-500">Round ${item.round}</p>
              <h3 class="text-xl font-bold text-emerald-700">
                ${item.college} — ${item.branch}
              </h3>
              <p class="text-sm mt-1 text-gray-600">
                Category: <b>${item.cat}</b>
              </p>
            </div>

            <div class="text-right">
              <p class="text-xs text-gray-500">Closing Rank</p>
              <p class="text-3xl font-extrabold text-emerald-700">
                ${item.close}
              </p>
              <p class="text-sm text-gray-700 mt-1">
                Marks: <b>${item.marks}</b>
              </p>
            </div>
          </div>
        </div>`;
      })
      .join("");
  });

</script>
